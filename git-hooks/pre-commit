#!/bin/bash

set -e

echo "ðŸ” Running pre-commit checks..."

ROOT_DIR="$(git rev-parse --show-toplevel)"
cd "$ROOT_DIR"

BACKEND_CHANGED=$(git diff --cached --name-only --diff-filter=ACM | grep "^bank-statements-api/" || true)
FRONTEND_CHANGED=$(git diff --cached --name-only --diff-filter=ACM | grep "^bank-statements-web/" || true)

if [ -n "$BACKEND_CHANGED" ]; then
  echo ""
  echo "ðŸ“¦ Backend changes detected"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  pnpm run verify:api

  echo "âœ… Backend checks passed"
fi

if [ -n "$FRONTEND_CHANGED" ]; then
  echo ""
  echo "ðŸŒ Frontend changes detected"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  pnpm run verify:web

  echo "âœ… Frontend checks passed"
fi

if [ -z "$BACKEND_CHANGED" ] && [ -z "$FRONTEND_CHANGED" ]; then
  echo "â„¹ï¸  No backend or frontend changes detected"
fi

cd "$ROOT_DIR"
git diff --cached --name-only | xargs git add 2>/dev/null || true

echo ""
echo "âœ… All pre-commit checks passed!"
echo ""
