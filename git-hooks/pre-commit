#!/bin/bash

set -e

echo "🔍 Running pre-commit checks..."

ROOT_DIR="$(git rev-parse --show-toplevel)"
cd "$ROOT_DIR"

BACKEND_CHANGED=$(git diff --cached --name-only --diff-filter=ACM | grep "^bank-statements-api/" || true)
FRONTEND_CHANGED=$(git diff --cached --name-only --diff-filter=ACM | grep "^bank-statements-web/" || true)

if [ -n "$BACKEND_CHANGED" ]; then
  echo ""
  echo "📦 Backend changes detected"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

  pnpm run verify:api

  echo "✅ Backend checks passed"
fi

if [ -n "$FRONTEND_CHANGED" ]; then
  echo ""
  echo "🌐 Frontend changes detected"
  echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

  pnpm run verify:web

  echo "✅ Frontend checks passed"
fi

if [ -z "$BACKEND_CHANGED" ] && [ -z "$FRONTEND_CHANGED" ]; then
  echo "ℹ️  No backend or frontend changes detected"
fi

cd "$ROOT_DIR"
git diff --cached --name-only | xargs git add 2>/dev/null || true

echo ""
echo "✅ All pre-commit checks passed!"
echo ""
